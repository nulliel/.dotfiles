#!/usr/bin/env bash

subheader "deadbeef"

#-- Config -----------------------------------------------------------------------------------------
local source_path="https://github.com/Alexey-Yakovenko/deadbeef/archive/0.7.2.tar.gz"
local mmkeys_path="https://github.com/nulliel/deadbeef-gnome-mmkeys/archive/1.0.0.tar.gz"

local source_version="0.7.2"
local deadbeef_version="0.0.0"

#-- Utilities --------------------------------------------------------------------------------------
get_deadbeef_version () {
  deadbeef_version="$(deadbeef --version 2>&1 | sed -n -e 's/^.*deadbeef //p;1q')"
}

#-- Check for existing installation ----------------------------------------------------------------
if command_exists "deadbeef"; then
  get_deadbeef_version

  if ! can_update "$deadbeef_version" "$source_version"; then
    skip "Installing deadbeef..."
    exit_subheader && return
  fi
fi

#-- Confirm installation ---------------------------------------------------------------------------
local update_string="Install deadbeef?"

if [[ "$deadbeef_version" != "0.0.0" ]]; then
  update_string="Update deadbeef? ($deadbeef_version -> $source_version)"
fi

if ! confirm_default "$update_string"; then
  skip "Installing deadbeef..."
  exit_subheader && return
fi

#-- Requires repositories --------------------------------------------------------------------------
if ! repository_activated "rpmfusion"; then
  log "Installing deadbeef..." && fail
  die "Build requires a missing repository 'rpmfusion'" 55
fi

#-- Dependencies -----------------------------------------------------------------------------------
install_build_tools

package_install "libtool"
package_install "intltool"
package_install "gettext"
package_install "gettext-devel"

package_install "libsamplerate-devel"
package_install "jansson-devel"
package_install "alsa-lib-devel"
package_install "libvorbis-devel"
package_install "libcurl-devel"
package_install "libogg-devel"
package_install "imlib2-devel"
package_install "libjpeg-turbo-devel"
package_install "libpng-devel"
package_install "libmad-devel"
package_install "mpg123"
package_install "flac-devel"
package_install "wavpack-devel"
package_install "libsndfile-devel"
package_install "libcdio-devel"
package_install "ffmpeg-devel"
package_install "dbus-devel"
package_install "pulseaudio-libs-devel"
package_install "faad2-devel"
package_install "zlib-devel"
package_install "libzip-devel"
package_install "yasm-devel"
package_install "mesa-libGLU-devel"
package_install "libcddb-devel"
package_install "libICE-devel"
package_install "libSM-devel"
# package_install "gstreamer-{ffmpeg,plugins-{good,ugly,bad{,-free,-nonfree}}}"
package_install "glib-devel"
package_install "glib2-devel"
package_install "gtk3-devel"

#-- Install ----------------------------------------------------------------------------------------
do_make_install "$source_path"
exit_header

sleep "0.05"

header "deadbeef-mm-keys"
do_make_install "$mmkeys_path"
exit_subheader
