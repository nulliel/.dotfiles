#!/usr/bin/env bash

subheader "mpv"

#-- Config -----------------------------------------------------------------------------------------
local source_path="https://github.com/mpv-player/mpv/archive/v0.21.0.tar.gz"

local source_version="0.21.0"
local mpv_version="0.0.0"

#-- utilities --------------------------------------------------------------------------------------
get_mpv_version () {
  mpv_version="$(mpv --version | sed -n -e 's/^.*mpv\s\(.*\)\s(.*/\1/p;1q')"
}

#-- Check for existing installation ----------------------------------------------------------------
if command_exists "mpv"; then
  get_mpv_version

  if ! can_update "$mpv_version" "$source_version"; then
    skip "Installing mpv..."
    exit_subheader && return
  fi
fi

#-- Confirm installation ---------------------------------------------------------------------------
local update_string="Install mpv?"

if [[ "$mpv_version" != "0.0.0" ]]; then
  update_string="Update mpv? ($mpv_version -> $source_version)"
fi

if ! confirm_default "$update_string"; then
  skip "Installing mpv..."
  exit_subheader && return
fi

#-- Dependencies -----------------------------------------------------------------------------------
install_build_tools

package_install "python"
package_install "python-docutils"
package_install "rst2pdf"
package_install "mesa-libgbm-devel"
package_install "ffmpeg-devel"
package_install "zlib"
package_install "libass-devel"
package_install "lua-devel"
package_install "clang"
package_install "libsmbclient-devel"
package_install "luajit-devel"
package_install "libbluray-devel"
package_install "libdvdread-devel"
package_install "libdvdnav-devel"
package_install "enca-devel"
package_install "libcdio-paranoia-devel"
package_install "libguess-devel"
package_install "uchardet-devel"
package_install "rubberband-devel"
package_install "lcms2-devel"
package_install "libXScrnSaver-devel"
package_install "libXv-devel"
package_install "libvdpau-devel"
package_install "libva-devel"
package_install "gstreamer1-vaapi"
package_install "libcaca-devel"
package_install "libv4l-devel"
package_install "perl-Math-BigRat"

#-- Install ----------------------------------------------------------------------------------------
do_waf_install "$source_path"

exit_subheader
