#!/usr/bin/env bash

#-- Config -----------------------------------------------------------------------------------------
readonly SCRIPT_NAME="$(basename "$0")"

readonly DOTFILES_DIR="${HOME}/.dotfiles"
readonly DOTFILES_TMP="${DOTFILES_DIR}/tmp"
readonly DOTFILES_BLD="${DOTFILES_DIR}/build"
readonly DOTFILES_LOG="${DOTFILES_DIR}/dotfiles.log"

readonly DOTFILES_GIT_REMOTE="https://github.com/nulliel/dotfiles.git"

#-- Don't mess with this ---------------------------------------------------------------------------
declare LOCKFILE_EXIT=false

#-- Options ----------------------------------------------------------------------------------------
set -o errexit     # Exit on most errors
set -o errtrace    # Inherit error traps
set -o nounset     # Disallow expansion of unset variables

#-- Traps ------------------------------------------------------------------------------------------
trap_err () {
  # Disable trap to prevent possible recursion
  trap - ERR

  # Undo logging
  if { true 1>&3; } 2>/dev/null; then
    exec 1>&3 2>&4 3>&- 4>&- 5>&- 6>&-
  fi

  # Consider further errors nonfatal so we can run to completion
  set +o errexit

  # Print fatal error
  printf "\n[\e[1;91mFatal\e[0m] Check the logfile at %s for more information.\n" "$DOTFILES_LOG"

  # Exit with failure status
  if [[ "$#" -eq 1 && "$1" =~ ^[0-9]+$ ]]; then
    exit "$1"
  else
    exit 1
  fi
}
trap_exit () {
  # Undo logging
  if { true 1>&3; } 2>/dev/null; then
    exec 1>&3 2>&4 3>&- 4>&- 5>&- 6>&-
  fi

  # Empty tmp directory
  if [[ -d "$DOTFILES_TMP" && "$LOCKFILE_EXIT" = false ]]; then
    rm -r "$DOTFILES_TMP"
  fi

  # Restore line wrapping
  tput smam
}

#-- Lockfile ---------------------------------------------------------------------------------------
acquire_lock () {
  local prefix="$1"
  local fd="${2:-200}"
  local lock_file="${DOTFILES_TMP}/$prefix.lock"

  # Create the lock
  eval "exec $fd>$lock_file"

  # Acquire the lock
  flock -n "${fd}" \
    && return 0 \
    || return 1
}

#-- Utilities --------------------------------------------------------------------------------------
parse_params () {
  INSTALL_DEFAULTS=false  # Perform all default actions without prompts
  NO_SYNC=false           # Don't sync dotfiles (OVERRIDES DEFAULTS)
  NO_RESTART=false        # Don't restart after the script finishes

  for opt in "$@"; do
    case "$opt" in
      --defaults)
        INSTALL_DEFAULTS=true
        ;;
      --no-restart)
        NO_RESTART=true
        ;;
      --no-sync)
        NO_SYNC=true
        ;;
      -h|--help)
        show_usage
        exit 0
        ;;
      -*|--*)
        printf "[\e[1;91mError\e[0m] Invalid option $opt\n"
        exit 1
        ;;
    esac
  done

  readonly INSTALL_DEFAULTS
  readonly NO_RESTART
  readonly NO_SYNC
}
show_banner () {
  clear
  printf '\e[1m'
  printf '          888          888     .d888 d8b 888                  \n'
  printf '          888          888    d88P"  Y8P 888                  \n'
  printf '          888          888    888        888                  \n'
  printf '      .d88888  .d88b.  888888 888888 888 888  .d88b.  .d8888b \n'
  printf '     d88" 888 d88""88b 888    888    888 888 d8P  Y8b 88K     \n'
  printf '     888  888 888  888 888    888    888 888 88888888 "Y8888b.\n'
  printf '     Y88b 888 Y88..88P Y88b.  888    888 888 Y8b.          X88\n'
  printf '      "Y88888  "Y88P"   "Y888 888    888 888  "Y8888   88888P" \e[0m\n\n'
}
show_usage () {
  cat <<EOF
Usage: $SCRIPT_NAME [options]

Options:
    -h, --help        Print this help text

Documentation can be found at https://github.com/nulliel/dotfiles/
EOF
}

#-- Main -------------------------------------------------------------------------------------------
main () {
  trap "trap_err" ERR
  trap "trap_exit" EXIT SIGINT SIGTERM SIGTSTP

  # Disable word wrapping
  tput rmam

  show_banner
  parse_params "$@"

  #-- Make sure we're in the right directory -------------------------------------------------------
  cd "${DOTFILES_DIR}" 2>/dev/null || {
    printf "[\033[1;91mError\033[0m] Dotfiles not found at %b\n" "${DOTFILES_DIR}"
    exit 10
  }

  #-- Create tmp folder ----------------------------------------------------------------------------
  if [[ ! -d "$DOTFILES_TMP" ]]; then
    mkdir "$DOTFILES_TMP"
  fi

  if [[ ! -d "$DOTFILES_BLD" ]]; then
    mkdir "$DOTFILES_BLD"
  fi

  #-- Acquire the lock -----------------------------------------------------------------------------
  acquire_lock "${SCRIPT_NAME}" || {
    LOCKFILE_EXIT=true

    printf "[\e[1;91mError\e[0m] Only one instance of %b can run at a time.\n" "${SCRIPT_NAME}"
    exit 11
  }

  #-- Ensure git is installed ----------------------------------------------------------------------
  source "${DOTFILES_DIR}/packages/git"

  #-- Sync repository ------------------------------------------------------------------------------
  source "${DOTFILES_DIR}/lib/internal/sync"

  #-- Call the rest of the script ------------------------------------------------------------------
  source "${DOTFILES_DIR}/bin/_dotfiles"
}

main "$@"
